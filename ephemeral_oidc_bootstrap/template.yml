AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: |
  This Epheremal Helper Bootstrapping Stack exists for one reason:
  make sure an OIDC Github Provider exists for this Account.
  The Function only needs to be run once.
  The created OIDC Provider is NOT part of this Stack but will be created isloated.
  When deploying this Stack SEPERATELY, it will create its own samconfig.toml. If you dont want this, just let the parent SAM template call this one as child.

Resources:
  OidcProviderCheckLambda:
    Type: AWS::Serverless::Function
    Properties:
      Handler: app.lambda_handler
      Role: !GetAtt OidcProviderCreationRole.Arn
      Runtime: python3.13
      CodeUri: ./py_create_oidc
      Timeout: 3 # seconds

  MyVirtualOidcProvider:
    Type: Custom::OidcProviderCheck
    Properties:
      ServiceToken: !GetAtt OidcProviderCheckLambda.Arn
      OidcClientId:    !Sub "sts.amazonaws.com"
      OidcProviderUrl: !Sub "https://token.actions.githubusercontent.com"
      OidcThumbPrint:  !Sub "6938fd4d98bab03faadb97b34396831e3780aea1"
      DeleteOidcWithCustomResource: false # default is false: do not delete the "real" OIDC as other stacks might need it!
      Timeout: 3 # seconds

  OidcProviderCreationRole:
    Type: AWS::IAM::Role
    Properties:
      ManagedPolicyArns:
        - "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: "AllowOidcProviderCreation"
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - iam:CreateOpenIDConnectProvider
                  - iam:ListOpenIDConnectProviders
                  - iam:TagOpenIDConnectProvider
                  - iam:DeleteOpenIDConnectProvider
                  - tag:TagResources
                  - tag:GetResources
                Resource: "*"
        - PolicyName: "AllowCloudWatchLogs"
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: arn:aws:logs:*:*:*
        # Hinzufügen der verwalteten Richtlinie AWSLambdaBasicExecutionRole, um CloudWatch Logs zu ermöglichen
