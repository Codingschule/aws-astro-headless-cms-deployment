---
const apiUrl = import.meta.env.PUBLIC_GUESTBOOK_API_URL || '';
---

<div 
    x-data="{
        apiUrl: $el.dataset.apiUrl,
        entries: [],
        isLoading: true,
        errorMessage: '',
        name: '',
        message: '',
        
        async init() {
            if (!this.apiUrl) {
                console.error('PUBLIC_GUESTBOOK_API_URL is not defined');
                this.errorMessage = 'Configuration error: API URL not set.';
                return;
            }

            try {
                const response = await fetch(this.apiUrl);
                if (!response.ok) throw new Error('Failed to fetch entries');
                const data = await response.json();
                this.entries = data.entries || [];
            } catch (error) {
                this.errorMessage = 'Failed to load guestbook entries. Please try again later.';
                console.error(error);
            } finally {
                this.isLoading = false;
            }
        },

        async submitForm() {
            if (!this.name || !this.message || !this.apiUrl) return;

            const currentName = this.name;
            const currentMessage = this.message;
            
            // Optimistic update
            this.entries.unshift({
                name: currentName,
                message: currentMessage,
                createdAt: new Date().toISOString()
            });
            
            // Reset form
            this.name = '';
            this.message = '';

            try {
                const response = await fetch(this.apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name: currentName, message: currentMessage })
                });

                if (!response.ok) throw new Error('Failed to submit entry');
            } catch (error) {
                this.errorMessage = 'Failed to submit entry.';
                console.error(error);
                // Revert optimistic update
                this.entries.shift();
                this.name = currentName;
                this.message = currentMessage;
            }
        }
    }"
    data-api-url={apiUrl}
    class="guestbook-container"
>
    <!-- Error Message -->
    <div
        x-show="errorMessage"
        x-text="errorMessage"
        class="error-message"
        style="color: red; margin-bottom: 1rem; display: none;"
    >
    </div>

    <!-- Loading State -->
    <div x-show="isLoading" class="loading-spinner">Loading guestbook...</div>

    <!-- Guestbook Entries -->
    <div x-show="!isLoading" class="entries-list">
        <template x-for="entry in entries" :key="entry.id">
            <div
                class="entry"
                style="border: 1px solid #ccc; padding: 1rem; margin-bottom: 1rem; border-radius: 8px;"
            >
                <div
                    style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;"
                >
                    <strong x-text="entry.name"></strong>
                    <span
                        x-text="entry.createdAt ? new Date(entry.createdAt).toLocaleDateString() : ''"
                        style="color: #666; font-size: 0.9em;"></span>
                </div>
                <p x-text="entry.message" style="margin: 0;"></p>
            </div>
        </template>

        <div
            x-show="entries.length === 0"
            style="text-align: center; color: #666;"
        >
            No entries yet. Be the first to sign the guestbook!
        </div>
    </div>

    <!-- New Entry Form -->
    <form
        @submit.prevent="submitForm"
        class="guestbook-form"
        style="margin-top: 2rem; padding: 1rem; background: #f9f9f9; border-radius: 8px;"
    >
        <h3>Sign the Guestbook</h3>
        <div style="margin-bottom: 1rem;">
            <label for="name" style="display: block; margin-bottom: 0.5rem;"
                >Name</label
            >
            <input
                type="text"
                id="name"
                x-model="name"
                required
                style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;"
            />
        </div>
        <div style="margin-bottom: 1rem;">
            <label for="message" style="display: block; margin-bottom: 0.5rem;"
                >Message</label
            >
            <textarea
                id="message"
                x-model="message"
                required
                rows="3"
                style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;"
            ></textarea>
        </div>
        <button
            type="submit"
            :disabled="!name || !message"
            style="background: #333; color: white; padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer;"
        >
            Sign Guestbook
        </button>
    </form>
</div>
