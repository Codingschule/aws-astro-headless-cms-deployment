# yaml-language-server: $schema=https://raw.githubusercontent.com/awslabs/goformation/v4/schema/cloudformation.schema.json
AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: "CloudFront OAC Website in private S3 bucket, generated by astro, with CD pipeline (later)"

Parameters:
  AppName: 
    Type: String
    Default: "cs-itp-ssg-cd"

Resources:
  MyWebBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "${AppName}-pub-dist-${AWS::Region}-${AWS::AccountId}"
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      # WebsiteConfiguration: # https://docs.aws.amazon.com/AmazonS3/latest/userguide/HostingWebsiteOnS3Setup.html
      # IndexDocument: index.html
      # ErrorDocument: error.html
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256

  # Origin Access Control f√ºr CloudFront
  MyOac:
    Type: AWS::CloudFront::OriginAccessControl
    Properties:
      OriginAccessControlConfig:
        Name: !Sub "${AWS::StackName}-oac"
        Description: "OAC for CloudFront to access S3"
        OriginAccessControlOriginType: s3
        SigningBehavior: always
        SigningProtocol: sigv4

  # CloudFront Distribution
  CloudFrontDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Enabled: true
        DefaultRootObject: "index.html"
        Origins:
          - Id: S3Origin
            DomainName: !GetAtt MyWebBucket.RegionalDomainName
            OriginAccessControlId: !Ref MyOac
            S3OriginConfig:
              OriginAccessIdentity: ""
        DefaultCacheBehavior:
          TargetOriginId: S3Origin
          ViewerProtocolPolicy: redirect-to-https
          AllowedMethods:
            - GET
            - HEAD
          CachedMethods:
            - GET
            - HEAD
          Compress: true
          CachePolicyId: "658327ea-f89d-4fab-a63d-7e88639e58f6"   # CachingOptimized policy AWS managed
        ViewerCertificate:
          CloudFrontDefaultCertificate: true
        HttpVersion: http2
        PriceClass: PriceClass_100

  # Optional: Bucket Policy um nur CloudFront Zugang zu erlauben
  BucketPolicyCloudFront:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref MyWebBucket
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: AllowCloudFrontServicePrincipal
            Effect: Allow
            Principal:
              Service: cloudfront.amazonaws.com
            Action: "s3:GetObject"
            Resource: !Sub "${MyWebBucket.Arn}/*"
            Condition:
              StringEquals:
                AWS:SourceArn: !Sub "arn:aws:cloudfront::${AWS::AccountId}:distribution/${CloudFrontDistribution}"

Outputs:
  # SiteURL:
  #   Value: !Sub "http://${MyWebBucket}.s3-website-${AWS::Region}.amazonaws.com" 
  BucketNameWeb:
    Value: !Sub "${MyWebBucket}" 
  DistributionId:
    Value: !Sub "${CloudFrontDistribution}"
  CloudFrontDomainName:
    Value: !GetAtt CloudFrontDistribution.DomainName
  DebugSyncCommand:
    Value: !Sub "aws s3 sync ./frontend/dist/ s3://${MyWebBucket} --delete --profile=myawsprofile" 
  BucketBlockedWebsite:
    Value: !Sub "http://${MyWebBucket}.s3-website-${AWS::Region}.amazonaws.com" 
  BucketBlockedUrl:
    Value: !Sub "https://${MyWebBucket}.s3.${AWS::Region}.amazonaws.com"